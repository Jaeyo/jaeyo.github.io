<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ko-KR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>MySQL 이 데이터를 안준다 | Hello, There</title>



<link href="http://jaeyo.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Hello, There" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="http://jaeyo.github.io/mysql-convert-tz-timezone/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="http://jaeyo.github.io/">
          <h1 id="nav-heading" class="title is-4">Hello, There</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/Jaeyo'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="facebook" href='https://facebook.com/jaeyo.developer'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/lastiverse'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/jaeyoyoyo'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:jaeyo.developer@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="about" href='/about'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/tech/">#tech</a>



  
  | <a class="subtitle is-6" href="/tags/trouble-shooting/">#trouble shooting</a>
  


      
    </div>
    <h2 class="subtitle is-6">February 5, 2021</h2>
    <h1 class="title">MySQL 이 데이터를 안준다</h1>
    
    <div class="content">
      <p>팀원 중 한분으로부터 헬프 요청이 왔다. 수정 중인 코드에서 버그가 생겼는데 원인을 도무지 모르겠다는 것이었다.</p>
<p>상황을 대충 들어보니 아래와 같았다.</p>
<p>특정 쿼리가 주기적으로 실행되면서 데이터를 가져온다. 그리고 로그에는 몇 건의 데이터를 가져왔는지를 찍고 있는데, 계속해서 쿼리 결과로 가져오는 데이터가 0건이라는 것이다.</p>
<p>헌데 이상한 것은, 해당 쿼리를 데이터베이스 툴을 통해 직접 때려보면 2건의 데이터가 조회된다.</p>
<p><strong>즉, 똑같은 쿼리를 서버의 런타임에서 날리면 0건, 데이터베이스 툴에서 직접 날리는 2건이 나오는 상황인 것이다.</strong></p>
<p>처음 의심한 포인트는 쿼리가 잘못 구성되었고, 그로 인해 ORM 을 통한 object 바인딩에 실패한 것이지 않을까 하는 부분 이었다. 하지만 object 바인딩에 실패하면 에러가 반환되어야 정상이었다. 문제의 코드에는 에러가 없었다.</p>
<p>그 다음에 의심한 포인트는, 실행중인 코드가 실제 코드와 다른 버전일 가능성을 의심해봤다. 팀원분께 여쭤보니 그건 아니었다.</p>
<p>더 많은 단서를 필요로 했다.</p>
<p>혹 환경 상의 문제는 아닐까 싶어 일단 코드가 돌고있는 pod 으로 직접 ssh 연결을 붙었다. mysql cli 툴을 깔아서 직접 해당 pod 에서 쿼리를 날려봤는데 정상적으로 2건이 반환되었다. 즉, 환경 상의 문제도 아니었다.</p>
<p>한참을 이런 저런 시도를 해봤으나 이상한 점은 보이지 않았다. IDE 에 문제의 쿼리를 띄워놓고 자세히 살펴보기 시작했다.</p>
<p>해당 쿼리가 참조하는 테이블의 컬럼에는 <code>start_time</code>, <code>end_time</code>, <code>timezone</code> 등의 컬럼이 있었다. <code>start_time</code>, <code>end_time</code> 에는 <code>hhMM</code> 포맷의 시간 데이터가 저장되어 있었다. 쿼리는 해당 <code>timezone</code> 을 기준으로 현재 시간이 <code>start_time</code> 과 <code>end_time</code> 사이에 속하는 행들을 조회하는 쿼리였다.</p>
<p>현재 시간을 <code>timezone</code> 기준으로 변경하는 부분은 아래와 같았다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">... CONVERT_TZ(NOW(), <span style="color:#e6db74">&#39;GMT&#39;</span>, timezone), ...
</code></pre></div><p>일단 <code>CONVERT_TZ</code> 함수 자체가 생소했기 때문에 MySQL 공식 문서를 통해 정의를 확인해보았다.</p>
<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_convert-tz"><code>CONVERT_TZ(*dt*,*from_tz*,*to_tz*)</code></a></p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_convert-tz"><code>CONVERT_TZ()</code></a> converts a datetime value <em>dt</em> from the time zone given by <em>from_tz</em> to the time zone given by <em>to_tz</em> and returns the resulting value.</p>
</blockquote>
<p>즉, <code>dt</code> 의 timezone 이 <code>from_tz</code> 라고 가정하고 이를 <code>to_tz</code> 기준으로 변경하는 함수인 것이다. 해당 함수의 사용법에는 딱히 문제가 없어보였다. 하지만 문득 든 생각이, <code>NOW()</code> 에서 반환하는 값이 <code>GMT</code> 가 아니라면 쿼리가 정상적으로 반환해야 할 행들을 반환하지 못할 수도 있다는 생각이 들었다.</p>
<p>다시 MySQL 문서를 찾아보니 <code>NOW()</code> 함수는 세션의 timezone 설정에 영향을 받는다고 적혀있었다. 백엔드에서 쿼리 중에 난데없이 세션의 timezone 을 변경할 일은 없다. 하지만 데이터베이스로 연결하는 초기 시점에 연결 문자열에서 세션의 timezone 을 설정할 수 있다. 해당 연결문자열을 찾아보니 아니나 다를까 timezone 이 Asia/Seoul 로 설정되어 있었다.</p>
<pre><code>parseTime=true&amp;charset=utf8&amp;loc=Local&amp;time_zone=%27Asia%2FSeoul%27
</code></pre><p><strong>잡았다 요놈</strong></p>
<p>연결문자열에서 timezone 설정을 날리고 코드를 다시 돌려보니 역시 정상적으로 2건의 데이터를 조회하는 것을 확인할 수 있었다.</p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/bash-is-not-async/">오늘의 삽질 - 괜히 Bash 만 의심했다.</a></li>
	
	<li><a href="/too-many-open-files/">Too many open files</a></li>
	
	<li><a href="/weird-requests/">아닌 밤중에 리퀘스트가 튄다?</a></li>
	
	<li><a href="/improving-alert-engine-1/">실시간 Alert Engine 개선기 (1)</a></li>
	
	<li><a href="/share-memory-by-communicating/">Share Memory By Communicating</a></li>
	
</ul>
</div>
      
    </div>
    
    
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-format="fluid"
     data-ad-layout="in-article"
     data-ad-client="ca-pub-5009679768762757"
     data-ad-slot="6857547199"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
  </div>
</section>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'jaeyo-blog';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-142557602-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

