<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ko-KR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>오늘의 삽질 - 괜히 Bash 만 의심했다. | Hello, There</title>



<link href="http://jaeyo.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Hello, There" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="http://jaeyo.github.io/bash-is-not-async/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="http://jaeyo.github.io/">
          <h1 id="nav-heading" class="title is-4">Hello, There</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/Jaeyo'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="facebook" href='https://facebook.com/jaeyo.developer'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/lastiverse'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/jaeyoyoyo'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:jaeyo.developer@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/tech/">#tech</a>



  
  | <a class="subtitle is-6" href="/tags/trouble-shooting/">#trouble shooting</a>
  


      
    </div>
    <h2 class="subtitle is-6">August 13, 2019</h2>
    <h1 class="title">오늘의 삽질 - 괜히 Bash 만 의심했다.</h1>
    
    <div class="content">
      <p>회사에서 만들어놓은 쉘 스크립트가 있었다. 필요한 패키지를 다운로드받아 설치하고 설정파일을 고치고 systemctl 로 띄우는 내용의 스크립트로 대략적인 모양새는 아래와 같다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">install_blabla<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
	dest<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp /tmp/blabla_XXXX.deb<span style="color:#66d9ef">)</span>
	curl -fsSL http://blabla.com/blabla.deb -o $dest
	dpkg -i $dest
	rm -f $dest
<span style="color:#f92672">}</span>

install_conf<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
	curl -fsSL http://blabla.com/blabla.conf -o /etc/blabla/blabla.conf
	sed -i -e <span style="color:#e6db74">&#34;...&#34;</span> /etc/blabla/blabla.conf
<span style="color:#f92672">}</span>

start_blabla<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
	systemctl start blabla
<span style="color:#f92672">}</span>

do_install<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
	install_blabla
	install_conf
	start_blabla
<span style="color:#f92672">}</span>

do_install
</code></pre></div><p>위의 스크립트에 따르면 아래의 로직을 타게 된다.</p>
<ol>
<li>curl 로 blabla.deb 다운로드</li>
<li>dpkg 로 blabla.deb 설치</li>
<li>curl 로 blabla.conf 다운로드</li>
<li>sed 로 blabla.conf 내용 수정</li>
<li>systemctl 로 blabla 시작</li>
</ol>
<p>이 로직대로 정상 작동 한다면 blabla는 수정된 설정파일을 정상적으로 물고 떠야한다. 하지만 blabla가 이상 동작을 한다는 이슈가 리포팅되었고, 확인 결과 수정된 설정파일이 아니라 기본 설정 파일을 물고 뜨는 것으로 의심이 되는 상황이었다.</p>
<p>하지만 아무리 확인을 해봐도 설정파일은 정상적으로 수정되어 있었고, 그렇다고 다른 path의 설정 파일을 물고 있는 상황도 아니었다.</p>
<p>순간 머리속을 스치는 의심 하나,</p>
<p>&ldquo;모종의 알 수 없는 이유로 blabla.conf 파일 다운로드가 채 끝나기 전에 다음 구문이 실행되었다면?&rdquo;</p>
<p>그래서 blabla를 재기동해보았고 정상적으로 수정된 설정 파일을 잘 물고 뜨는 걸 확인할 수 있었다. 갑작스레 혼란이 밀려왔다.</p>
<p>&ldquo;아니, 무슨 bash가 node.js 도 아니고 상황에 따라서 curl 명령이 끝나기 전에 다음 구문으로 넘어갈 수가 있나? 무슨 bash가 async야?&rdquo;</p>
<p>혹시나 싶어서 구글링을 해봤지만 걸리는 건 없었고 사건이 터진 이유를 알 수 없어 혼란스러워 하던 즈음, 옆 동료 분이 원인을 정확하게 짚어주셨다.</p>
<p>&ldquo;이거 dpkg 로 설치하고 바로 뜨는 것 같은데요.&rdquo;</p>
<p>문제는 당연히 bash 가 async 로 동작했다거나 그런게 아니었고 ubuntu 기준으로 dpkg로 설치되는 패키지는 서비스가 포함되어 있으면 자동으로 enabled &amp;&amp; started 되는 현상이었다.</p>
<p>괜히 의심했던 것 같아 bash 에게 사과를&hellip;</p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/too-many-open-files/">Too many open files</a></li>
	
	<li><a href="/weird-requests/">아닌 밤중에 리퀘스트가 튄다?</a></li>
	
	<li><a href="/better-than-yesterday/">연봉과 연차의 무게</a></li>
	
	<li><a href="/error-while-building-qmk_firmware/">qmk_firmware 빌드 시에 chibios 관련 에러 발생</a></li>
	
	<li><a href="/reselect/">reselect</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'jaeyo-blog';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-142557602-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

